#Author: Partho KR
#Last modified on 1/1/20
import requests, pickle
import json
import sys
import subprocess as sp
from getpass import getpass
from bs4 import BeautifulSoup
email = input("Enter facebook email: ")
passw = getpass("Enter facebook password: ")
headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.87 Safari/537.36 OPR/37.0.2178.31'}
payload = {'email':email,'pass':passw}
exclude_friends = []
tmp = sp.call('clear',shell=True)
print("Collecting info...")
session = requests.Session()
source = session.post('https://mbasic.facebook.com/login/device-based/regular/login/',headers = headers,data=payload)
soup = BeautifulSoup(source.text, 'lxml')
if(soup.findAll(text="Did you forget your password?") or soup.findAll(text="Find your account.")):
    print("Wrong authentication\nRestart application")
    sys.exit()
cookies = source.cookies.get_dict()
tmp = sp.call('clear',shell=True)
print("|------------------Block facebook friends---------------------|")
print("1. Exclude some friends by name ");
print("2. Block all");
ch = input("Enter choice: ")
if(ch == '1'):
    n = input("How many friends you want to exclude? : ")
    print("Be careful when typing friend's name to exclude from blocking. Misspelling may lead to block him/her.")
    print("*For reliability copy paste friend's name*\n")
    for i in range(0,int(n)):
        temp_name = input("Enter "+str(i+1)+"th friend name: ");
        exclude_friends.append(temp_name)

plink = ""
for line in soup.find_all('a'):
    if(line.text == "Profile"):
        plink = line.get('href')
        break

psource = session.get('https://mbasic.facebook.com'+plink).text;
psoup = BeautifulSoup(psource, 'lxml')

flink = []
friend_plink = []
friend_name = []
for line in psoup.find_all('a'):
    if(line.text == "Friends" and not line.has_attr('accesskey')):
        flink.append(line.get('href'));
def go_next(next_uri):
    fsource = session.get('https://mbasic.facebook.com'+next_uri);
    fsoup = BeautifulSoup(fsource.text, 'lxml')
    all = fsoup.find_all("a");
    count_friend = 0
    recursion = -1
    if not(fsoup.findAll(text = "See More Friends")):
        recursion = 0
    else:
        recursion = 1
    for link in all:
        if(link.text == "Â Only me"):
            count_friend = 1
            continue
        if(recursion == 1):
            if(link.text == "See More Friends"):
                flink[0] = link.get('href')
                count_friend = 0
                go_next(flink[0])
        if(recursion == 0):
            if(link.text == "Create Page"):
                count_friend = 0
                break
        if(count_friend == 1):
            if not link.text in exclude_friends:
                friend_plink.append(link.get('href'))
                friend_name.append(link.text)

print("Collecting account id...")
go_next(flink[0])

print("Blocking started...")
                                         ### Block method ####
for single_friend in friend_plink:
    fpsource = session.get('https://mbasic.facebook.com'+single_friend);
    fpsoup = BeautifulSoup(fpsource.text, 'lxml')
    for line in fpsoup.find_all('a'):
        if(line.text == "Block this person"):
            blink = line.get('href')
            fbsource = session.get('https://mbasic.facebook.com'+blink);
            fbsoup = BeautifulSoup(fbsource.text, 'lxml')
            all_form = fbsoup.find_all("form");
            fb_dtsg = fbsoup.find('input',{'name':'fb_dtsg'}).get('value')
            jazoest = fbsoup.find('input',{'name':'jazoest'}).get('value')
            block_payload = {'fb_dtsg':fb_dtsg,'jazoest':jazoest,'confirmed':'Block'}
            fbfsource = session.post('https://mbasic.facebook.com'+all_form[1].get('action'),data=block_payload);
            print("Blocked " + friend_name[friend_plink.index(single_friend)])
            break
